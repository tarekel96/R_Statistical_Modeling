---
title: "Airbnb NYC"
author: "Tarek El-Hajjaoui"
date: "2023-04-23"
output: html_document
---

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
# library
library(tidyverse)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(kableExtra)
library(knitr)
```

### Q 4.11.3.1 Airbnb in NYC
Perform an EDA, build a model, and interpret model coefficients to describe variation in the number of reviews (a proxy for the number of rentals, which is not available) as a function of the variables provided. Donâ€™t forget to consider an offset, if needed.

```{r}
# Loading the dataset
file_path = './NYCairbnb.csv'
df = read.csv(file_path, header = TRUE)
```

```{r}
# View dataframe summary
str(df)
```

#### Explanatory Data Analysis (EDA)

Preprocessing - transforming data types
```{r}
# Transforming categorical columns to factor data type.
categorical_cols <- c('room_type', 'bathrooms', 'bedrooms', 'review_scores_cleanliness', 'review_scores_location', 'review_scores_value', 'instant_bookable')
df[categorical_cols] <- lapply(df[categorical_cols], as.factor)

# Transforming date columns
date_cols <- c('last_scraped', 'host_since')
df[date_cols] <- lapply(df[date_cols], as.Date)
```

**Checking if the data justifies a Poisson regression model.**

Plotting the $Y$, number of reviews.
```{r}
ggplot(df, aes(number_of_reviews)) +
  geom_histogram(binwidth = .25, color = "black", fill = "white") +
  xlim(0, 75) +
  xlab("Number of reviews.") +
  ylab("Count of the number of reviews.")
```

- Number of reviews appears to follow a Poisson distribution given by the right-skewed histogram above. As the number of reviews increases, the count of the number of reviews decreases.

Checking for the assumption of $\mu = \sigma^2$ (mean = variance).
```{r, echo=FALSE, message = FALSE}

# Mean = Variance [group by review_scores_cleanliness]
table1<- df  %>% group_by(review_scores_cleanliness)  %>% 
  summarise(mnNum= mean(number_of_reviews),varNum=var(number_of_reviews),n=n())
k1 <- kable(table1, booktabs=T, 
      caption="Compare mean and variance of the number of reviews for the review score cleaniness groups.",col.names = c("review_scores_cleanliness", "Mean", "Variance", "n")) %>% kable_styling(full_width = F)

# Mean = Variance [group by review_scores_location]
table2<- df  %>% group_by(review_scores_location)  %>% 
  summarise(mnNum= mean(number_of_reviews),varNum=var(number_of_reviews),n=n())
k2 <- kable(table2, booktabs=T, 
      caption="Compare mean and variance of the number of reviews for the review score location groups.",col.names = c("review_scores_location", "Mean", "Variance", "n"))%>% kable_styling(full_width = F)

# Mean = Variance [group by review_scores_value]
table3<- df  %>% group_by(review_scores_value)  %>% 
  summarise(mnNum= mean(number_of_reviews),varNum=var(number_of_reviews),n=n())
k3 <- kable(table3, booktabs=T, 
      caption="Compare mean and variance of the number of reviews for the review score value groups.",col.names = c("review_scores_value", "Mean", "Variance", "n")) %>% kable_styling(full_width = F)

# display mean and variance tables of features
k1 
k2
k3
```
There is some evidence of a violation of the mean=variance assumption. It appears that the variance is smaller than the mean for lower number of reviews, while the variance is greater than the mean for higher number of reviews. 

The Poisson regression model implies that log($\lambda_i$) is a linear function of feature variables; i.e., $log(\lambda_i)=\beta_0+\beta_1\textrm{feature}_i$. Therefore, to check the linearity assumption for Poisson regression, we would like to plot log($\lambda_i$) by $feature_i$.

```{r}
# Remove rows where x is null
df_no_nulls <- df[complete.cases(df), ]

sumStats <- df_no_nulls %>% group_by(review_scores_cleanliness) %>% 
  summarise(mn_reviews = mean(number_of_reviews),
            logmn_reviews = log(mn_reviews), n=n())

sumStats2 <- df_no_nulls %>% group_by(review_scores_location) %>% 
  summarise(mn_reviews = mean(number_of_reviews),
            logmn_reviews = log(mn_reviews), n=n())

sumStats3 <- df_no_nulls %>% group_by(review_scores_value) %>% 
  summarise(mn_reviews = mean(number_of_reviews),
            logmn_reviews = log(mn_reviews), n=n())

plot1 <- ggplot(sumStats, aes(x=review_scores_cleanliness, y=logmn_reviews)) +
  geom_point()+
  geom_smooth()+
  xlab("review_scores_cleanliness") +
  ylab("log(n_reviews)") 

plot2 <- ggplot(sumStats2, aes(x=review_scores_location, y=logmn_reviews)) +
  geom_point()+
  geom_smooth()+
  xlab("review_scores_location") +
  ylab("log(n_reviews)") 

plot3 <- ggplot(sumStats3, aes(x=review_scores_value, y=logmn_reviews)) +
  geom_point()+
  geom_smooth()+
  xlab("review_scores_value") +
  ylab("log(n_reviews)") 

# Arrange the plots in a row using grid.arrange()
grid.arrange(plot1, plot2, plot3, ncol = 2)
```


<!-- ```{r} -->
<!-- # Create a matrix for plots -->
<!-- # par(mfrow = c(1, 1)) -->


<!-- # Set up the plotting device with a larger width -->
<!-- options(repr.plot.width = 8, repr.plot.height = 4) -->
<!-- # Set the margins for each individual plot -->
<!-- par(mar = c(4, 4, 2, 1),mfrow = c(2, 2)) -->
<!-- plot(df[['review_scores_cleanliness']], df$number_of_reviews, xlab='review_scores_cleanliness', ylab="number_of_reviews", type = "h") -->
<!-- plot(df[['review_scores_location']], df$number_of_reviews, xlab='review_scores_location', ylab="number_of_reviews", type = "h") -->
<!-- plot(df[['review_scores_value']], df$number_of_reviews, xlab='review_scores_value', ylab="number_of_reviews", type = "h") -->
<!-- plot(df[['days']], df$number_of_reviews, xlab='days', ylab="number_of_reviews", type = "p", xlim=c(0,3500)) -->
<!-- ``` -->

Most of the graphs above suggest that the number of reviews follow a Poisson distribution (discussed more below).

- Number of reviews appears to follow a Poisson distribution based on variables: price, number of bedrooms, number of bathrooms, review score cleanliness, review scores location, and review scores value. For example, the plot with price appears to be a Poisson distribution with a right-skew which is commonly found in Poisson samples. On the other hand, number of days the unit has been listed does not appear to follow a Poisson distribution.
